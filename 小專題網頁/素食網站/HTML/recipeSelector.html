<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="綠藝饗宴 - 最佳素食食譜平台" />
    <title>食譜瀏覽 - 綠藝饗宴</title>
    <link rel="stylesheet" href="../CSS/recipeSelector.css" />
</head>

<body>

    <!-- 頁首 -->
    <header>
        <!-- Modal Container -->
        <div class="modal-container">
            <!-- 登入 Modal -->
            <div id="login-modal" class="modal">
                <div class="modal-content">
                    <button class="close-btn" aria-label="Close">&times;</button>
                    <h2>登入</h2>
                    <form id="login-form">
                        <div class="form-group">
                            <label for="login-email">電子郵件:</label>
                            <input type="email" id="login-email" maxlength="100" required>
                        </div>
                        <div class="form-group">
                            <label for="login-password">密碼:</label>
                            <input type="password" id="login-password" maxlength="20" required>
                        </div>
                        <button type="submit" class="btn-primary">登入</button>
                    </form>
                    <p>尚未註冊嗎？ <button id="show-register">註冊</button></p>
                </div>
            </div>

            <!-- 註冊 Modal -->
            <div id="register-modal" class="modal">
                <div class="modal-content">
                    <button class="close-btn" aria-label="Close">&times;</button>
                    <h2>註冊</h2>
                    <form id="register-form">
                        <div class="form-group">
                            <label for="reg-username">姓名:</label>
                            <input type="text" id="reg-username" maxlength="20" required>
                        </div>
                        <div class="form-group">
                            <label for="reg-email">電子郵件:</label>
                            <input type="email" id="reg-email" maxlength="50" required>
                            <span id="email-error" class="error-message"></span>
                        </div>
                        <div class="form-group">
                            <label for="reg-password">密碼:</label>
                            <input type="password" id="reg-password" maxlength="20" required>
                        </div>
                        <div class="form-group">
                            <label for="reg-password">確認密碼:</label>
                            <input type="password" id="confirm-password" maxlength="20" required>
                        </div>
                        <button type="submit" class="btn-primary">註冊</button>
                    </form>
                    <p>已有帳號？ <button id="show-login">登入</button></p>
                </div>
            </div>
        </div>

        <!-- 導覽列 -->
        <nav class="nav-container">
            <!-- 第一列 -->
            <div class="member-menu">
                <span id="login-status"></span>
                <button id="login-out"></button>
                <a id="login-register" href="#">
                    <img class="login-singup" src="../img/icons/user.png" alt="登入註冊" />
                    <span id="user-state" class="tooltip">登入註冊</span>
                </a>
                <a href="#">
                    <img class="shopping-cart" src="../img/icons/shopping-cart.png" alt="購物車" />
                    <span class="tooltip">購物車</span>
                </a>
                <a href="#">
                    <img class="contact-us" src="../img/icons/message.png" alt="聯絡我們" />
                    <span class="tooltip">聯絡我們</span>
                </a>
            </div>

            <!-- 第二列 -->
            <div class="logo-container">
                <a href="../index.html"><img class="logo" src="../img/vegetable_LOGO.jpg" alt="綠藝饗宴 LOGO" /></a>
                <a href="../index.html">
                    <h1 class="site-title">綠藝饗宴</h1>
                </a>
            </div>

            <!-- 第三列 -->
            <div class="menu-container">
                <div class="hamburger-menu" onclick="toggleMenu()">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
                <ul class="main-menu">
                    <li><a href="../index.html">首頁</a></li>
                    <li class="dropdown">
                        <a href="#">食譜分類&#9662;</a>
                        <ul class="submenu">
                            <li><a href="./recipeSelector.html?category=早餐">早餐</a></li>
                            <li><a href="./recipeSelector.html?category=飯">飯</a></li>
                            <li><a href="./recipeSelector.html?category=麵">麵</a></li>
                            <li><a href="./recipeSelector.html?category=米粉">米粉</a></li>
                            <li><a href="./recipeSelector.html?category=蔬菜">蔬菜</a></li>
                            <li><a href="./recipeSelector.html?category=鹹點">鹹點</a></li>
                            <li><a href="./recipeSelector.html?category=甜點">甜點</a></li>
                        </ul>
                    </li>
                    <li><a href="#">營養資訊</a></li>
                    <li><a href="#">購物清單</a></li>
                    <li><a href="#">聯絡我們</a></li>
                    <li><a href="#">常見問題</a></li>
                </ul>
            </div>
        </nav>
        <!-- 第四列 -->
        <div class="recipe-actions">
            <!-- 搜尋區塊 -->
            <div class="search-container">
                <label>立即探索食譜</label>
                <form id="globalSearchForm">
                    <input type="text" id="search-input" name="search" placeholder="搜尋食譜或輸入食材" />
                    <button type="button" id="clear-btn" aria-label="清除">×</button>
                    <button type="submit" id="search-btn">
                        <img class="search-icon" src="../img/icons/search.png" alt="搜尋" />
                    </button>
                </form>
            </div>
            <!-- 上傳食譜 -->
            <a class="upload-button" href="./uploadRecipe.html">上傳您的素食食譜</a>
        </div>
    </header>

    <!-- 內容 -->
    <div class="recipeSelector-container">
        <!-- 頁面頂部篩選和排序選項 -->
        <div class="filter-sort-container">
            <label for="sort">排序：</label>
            <select id="sort" name="sort">
                <option value="all">全部</option>
                <option value="time">烹飪時間</option>
                <option value="difficulty">難度</option>
                <option value="rating">評價</option>
                <option value="latest">最新</option>
                <option value="popular">最受歡迎</option>
            </select>
            <label for="filter">篩選：</label>
            <select id="filter" name="filter">
                <option value="vegetables">蔬菜</option>
                <option value="quick-dish">快手菜</option>
                <option value="healthy-cooking">健康料理</option>
                <option value="vegan">純素</option>
                <option value="lacto-ovo-vegetarian">蛋奶素</option>
                <option value="gluten-free">無麩質</option>
            </select>
        </div>

        <!-- 頁籤 -->
        <div class="breadcrumb"><!-- 動態生成頁籤 --></div>

        <!-- 燈箱結構 -->
        <div class="lightbox" id="lightbox">
            <div class="lightbox-content">
                <img src="" alt="放大檢視" id="lightbox-img" />
            </div>
        </div>

        <!-- 食譜簡介卡片 -->
        <div id="recipeCardContainer"><!-- 動態生成各類食譜 --></div>

        <!-- 最新/推薦食譜 -->
        <div class="suggest-recipes">
            <h2>推薦食譜</h2>
            <div class="suggest-card-container" id="suggestCardContainer"> <!-- 動態生成各類食譜 --></div>
        </div>

        <!-- 反饋區塊 -->
        <div class="feedback-section">
            <h3>您的反饋</h3>
            <form action="#" method="POST">
                <textarea name="feedback" id="feedback" rows="4" placeholder="請留下您的意見和建議"></textarea>
                <button type="submit">提交</button>
            </form>
        </div>
    </div>

    <!-- 回到頂部按鈕 -->
    <img id="back-to-top" class="up-arrow" src="../img/icons/up-arrow_11044298.png" alt="回到頂部" />

    <!-- 頁尾 -->
    <footer>
        <div class="footer-container">
            <div class="footer-links">
                <a href="#">關於我們</a>
                <a href="#">常見問題</a>
                <a href="#">隱私政策</a>
                <a href="#">使用條款</a>
                <a href="#">聯絡我們</a>
            </div>
            <div class="social-media-icons">
                <a href="#"><img src="../img/icons/line.png" alt="Line" /></a>
                <a href="#"><img src="../img/icons/instagram.png" alt="Instagram" /></a>
                <a href="#"><img src="../img/icons/facebook.png" alt="Facebook" /></a>
            </div>
            <p>Copyright &copy; 2025 綠藝饗宴</p>
        </div>
    </footer>

    <script>

        let loggedInUser = localStorage.getItem('loggedInUser'); // 儲存當前登入的使用者
        // 解析 URL 中的參數
        const urlParams = new URLSearchParams(window.location.search);
        const category = urlParams.get('category'); // 再次取得 category
        const keyword = urlParams.get('search'); // 取得搜尋關鍵字參數

        // 取得預設數據（從 JSON 檔案）與 localStorage 中的數據
        async function getRecipesData() {
            try {
                // 透過 fetch 取得預設數據
                const response = await fetch("../recipes.json");
                const defaultRecipes = await response.json();

                // 從 localStorage 取得用戶新增的數據
                const storedData = localStorage.getItem('recipes');
                const storedRecipes = storedData ? JSON.parse(storedData) : [];

                // 合併預設數據與 localStorage 中的數據
                return [...defaultRecipes, ...storedRecipes];
            } catch (error) {
                console.error('Error fetching recipes:', error);
            }
        }

        // 搜尋篩選函式
        function search(keyword, recipesData) {
            // 將關鍵字轉為小寫標準化
            const searchKeyword = keyword.toLowerCase();
            // console.log(searchKeyword)
            // console.log(recipesData)
            return recipesData.filter(recipe => {
                // 標題比對
                const titleMatch = recipe.recipe_title.toLowerCase().includes(searchKeyword);
                // 描述比對
                const descriptionMatch = recipe.recipe_description.toLowerCase().includes(searchKeyword);
                // 食譜標籤陣列比對
                const tagMatch = recipe.tags && recipe.tags.some(tag =>
                    tag.toLowerCase().includes(searchKeyword)
                );
                return titleMatch || descriptionMatch || tagMatch;
            });
        }

        // 取得食譜數據 建立頁面內容 or 關鍵字篩選後的內容
        function renderRecipes(recipesData) {
            try {
                // 將獲取的數據應用於動態生成網頁內容
                if (recipesData && Array.isArray(recipesData)) {
                    // 根據 keyword 決定要使用的數據：
                    // 如果 keyword 存在且有內容，則過濾出符合條件的食譜，否則就使用所有食譜數據
                    const dataToRender =
                        keyword && keyword.trim() !== "" ? search(keyword, recipesData) : recipesData;
                    // 食譜卡片區塊
                    const recipeCardContainer = document.getElementById("recipeCardContainer");
                    // 食譜卡片區塊
                    const suggestCardContainer = document.getElementById("suggestCardContainer");
                    // 使用 DocumentFragment 優化多次 DOM 插入 如果食譜數據筆數較多，插入每個新的元素到 DOM 都可能引發重排（reflow）與重繪（repaint）。使用 DocumentFragment 來先建立所有卡片，最後一次性把碎片插入到 DOM，從而減少瀏覽器的重排次數。
                    const fragment = document.createDocumentFragment();
                    const suggestFragment = document.createDocumentFragment();
                    // --- 主要食譜區塊依據關鍵字迭代 ---
                    dataToRender.forEach(recipe => {
                        // 建立食譜簡介區塊
                        const card = createRecipeCard(recipe);
                        // 將 card 插入 fragment
                        fragment.append(card);
                    });
                    // --- 推薦區塊顯示所有的食譜數據 ---
                    recipesData.forEach(recipe => {
                        // 建立食譜推薦區塊
                        const suggestCard = createSuggestRecipeCard(recipe);
                        // 將 suggestCard 插入 suggestFragment
                        suggestFragment.append(suggestCard);
                    });
                    // 一次性把所有卡片插入容器
                    recipeCardContainer.append(fragment);
                    suggestCardContainer.append(suggestFragment);
                }
            } catch (error) {
                console.error('Error processing recipes:', error);
            }
        }

        // 建立食譜卡片函式
        function createRecipeCard(recipe) {
            // 動態變更頁籤內容
            const breadcrumb = document.querySelector('.breadcrumb');
            breadcrumb.innerHTML = `
                <a href="../index.html">首頁</a>
            `;
            if (category) {
                breadcrumb.innerHTML += `
                    >
                    <a href="#">${category}</a>
                `;
            }

            // 建立食譜卡片
            const recipeCard = document.createElement("div");
            recipeCard.classList.add("recipe-card");

            // 建立圖片
            const recipeImg = document.createElement('img');
            recipeImg.classList.add('recipe-img');
            if (recipe.recipe_image) {
                recipeImg.src = recipe.recipe_image;
            } else {
                recipeImg.src = '../img/image_Not_Found.png';
                recipeImg.classList.add('not-found-img');
            }
            recipeImg.alt = recipe.recipe_title;

            // 建立內容區塊
            const recipeText = document.createElement('div');

            // 建立連結區塊
            const recipeLink = document.createElement('a');
            recipeLink.classList.add('content');
            recipeLink.href = `./recipe.html?category=${category}&id=${recipe.recipe_id}`;

            // 標題
            const recipeTitle = document.createElement('h2');
            recipeTitle.textContent = recipe.recipe_title;

            // 標籤
            const recipeTag = document.createElement('p');
            (recipe.tags || []).forEach(tag => {
                const spanTag = document.createElement('span');
                spanTag.classList.add('tag');
                spanTag.textContent = tag;
                recipeTag.append(spanTag);
            });

            // 簡介
            const recipeDesc = document.createElement('p');
            recipeDesc.classList.add('recipe-description');
            recipeDesc.textContent = recipe.recipe_description;

            // 食材（並用「,」隔開）
            const recipeIngredients = document.createElement('p');
            recipeIngredients.textContent = '主要食材：';
            recipe.ingredients.forEach((ingredient, index) => {
                const name = document.createElement('span');
                name.textContent = ingredient.name;
                if (index < recipe.ingredients.length - 1) {
                    name.textContent += ', ';
                }
                recipeIngredients.append(name);
            });

            // 時間
            const recipeTime = document.createElement('p');
            recipeTime.textContent = '製作時間：' + recipe.recipe_cook_time;

            // 組合 連結區塊
            recipeLink.append(recipeTitle, recipeTag, recipeDesc, recipeIngredients, recipeTime);

            // 建立互動區塊(非使用者輸入數據)
            const recipeActions = document.createElement('div');
            recipeActions.classList.add('actions');

            const createLink = (text, href = '#') => {
                const link = document.createElement('a');
                link.href = href;
                link.textContent = text;
                return link;
            };

            // 評分連結
            const ratingLink = createLink(recipe.rating > 0 ? `評分：${recipe.rating} / 5 （${recipe.evaluate} 評價）` : '尚未有評價');
            // 作者連結(若作者名稱是動態資料，可改由 recipe.author 提供)
            const authorLink = createLink('作者：栗子');
            // 喜歡連結
            const likesLink = createLink(`喜歡：${recipe.likes}`);
            // 留言連結
            const commentLink = createLink(`留言：${recipe.comments}`);


            // 收藏按鈕
            const collectBtn = document.createElement('button');
            collectBtn.classList.add('bookmark-button');
            collectBtn.textContent = '收藏';
            collectBtn.addEventListener('click', () => {
                if (!loggedInUser) {
                    alert('請先登入以收藏食譜！');
                } else {
                    alert(`收藏成功！已收藏食譜：${recipe.recipe_title}`);
                    // 在此加入收藏邏輯，例如儲存到收藏列表
                }
            });

            // 分享按鈕
            const shareBtn = document.createElement('button');
            shareBtn.classList.add('share-button');
            shareBtn.textContent = '分享';
            shareBtn.addEventListener('click', () => {
                alert('分享成功');
            });

            // 組合 互動區塊
            recipeActions.append(ratingLink, authorLink, likesLink, commentLink, collectBtn, shareBtn);

            // 組合 連結區塊、互動區塊
            recipeText.append(recipeLink, recipeActions);
            // 組合卡片
            recipeCard.append(recipeImg, recipeText);
            return recipeCard;
        }

        // 建立推薦卡片函式
        function createSuggestRecipeCard(recipe) {
            // 建立推薦卡片
            const suggestCard = document.createElement('div');
            suggestCard.classList.add('suggest-recipe-card');

            // 建立連結元素，並設定連結到詳細食譜頁
            const link = document.createElement('a');
            link.href = `./recipe.html?category=${category}&id=${recipe.recipe_id}`;

            // 建立圖片元件
            const img = document.createElement('img');
            if (recipe.recipe_image) {
                img.src = recipe.recipe_image;
            } else {
                img.src = "../img/image_Not_Found.png";
                img.classList.add('not-found-img');
            }
            img.alt = recipe.recipe_title;

            // 建立標題 (h3) 元素
            const title = document.createElement('h3');
            title.textContent = recipe.recipe_title;

            // 建立標籤區塊
            const tagBox = document.createElement('div');
            tagBox.classList.add('tags');
            // 遍歷每個標籤，並建立 <span>
            (recipe.tags || []).forEach((tag) => {
                const suggestTag = document.createElement('span');
                suggestTag.textContent = tag;
                tagBox.append(suggestTag);
            });

            // 建立描述 (p) 元素
            const description = document.createElement('p');
            description.textContent = recipe.recipe_description;

            // 將圖、標題、標籤與描述加入連結元素中
            link.append(img, title, tagBox, description);

            // 建立動作按鈕區塊
            const actionsBox = document.createElement('div');
            actionsBox.classList.add('actions');

            // 建立顯示評分的連結文字
            const actionsLink = document.createElement('a');
            actionsLink.textContent = recipe.rating > 0 ? `評分：${recipe.rating} / 5（${recipe.evaluate} 評價）` : '尚未有評價';

            // 建立按鈕容器
            const actionsBtn = document.createElement('div');

            // 建立收藏按鈕
            const collectBtn = document.createElement('button');
            collectBtn.textContent = '收藏';
            collectBtn.addEventListener('click', () => {
                if (!loggedInUser) {
                    alert('請先登入以收藏食譜！');
                } else {
                    alert(`收藏成功！已收藏食譜：${recipe.recipe_title}`);
                    // 在此加入收藏邏輯，例如儲存到收藏列表
                }
            });

            // 建立分享按鈕
            const shareBtn = document.createElement('button');
            shareBtn.textContent = '分享';
            shareBtn.addEventListener('click', () => {
                alert('分享成功');
            });

            // 將集合按鈕放入按鈕容器中
            actionsBtn.append(collectBtn, shareBtn);

            // 將評分連結和按鈕容器加入按鈕區塊中
            actionsBox.append(actionsLink, actionsBtn);

            // 將連結元素與按鈕區塊加入整個 suggestCard
            suggestCard.append(link, actionsBox);
            return suggestCard;
        }

        document.addEventListener('DOMContentLoaded', async () => {
            getRecipesData();
            const allRecipesData = await getRecipesData();
            renderRecipes(allRecipesData);
            // 使用者是否登入
            loggedInUser = loggedInUser ? JSON.parse(loggedInUser) : null;
        })
    </script>

    <script src="../JS/recipeSelector.js"></script>
    <script src="../JS/all.js"></script>
</body>

</html>