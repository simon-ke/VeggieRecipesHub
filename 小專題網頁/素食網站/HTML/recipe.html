<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="綠藝饗宴 - 最佳素食食譜平台">
    <title>食譜詳情 - 綠藝饗宴</title>
    <link rel="stylesheet" href="../CSS/recipe.css">
</head>

<!-- 此頁面為素食食譜詳細資訊的瀏覽頁 專題網站單純使用前端技術不加入後端相關技術 -->

<body>
    <!-- 頁首 -->
    <header>
        <!-- 登入 Modal -->
        <div>
            <div id="login-modal" class="modal">
                <div class="modal-content">
                    <span class="close-btn">&times;</span>
                    <h2>登入</h2>
                    <form id="login-form">
                        <label for="login-username">使用者名稱:</label>
                        <input type="text" id="login-username" required>

                        <label for="login-password">密碼:</label>
                        <input type="password" id="login-password" required>

                        <button type="submit">登入</button>
                    </form>
                    <p>尚未註冊嗎？ <a href="#" id="show-register">註冊</a></p>
                </div>
            </div>

            <!-- 註冊 Modal -->
            <div id="register-modal" class="modal">
                <div class="modal-content">
                    <span class="close-btn">&times;</span>
                    <h2>註冊</h2>
                    <form id="register-form">
                        <label for="reg-username">使用者名稱:</label>
                        <input type="text" id="reg-username" required>

                        <label for="reg-email">電子郵件:</label>
                        <input type="email" id="reg-email" required>

                        <label for="reg-password">密碼:</label>
                        <input type="password" id="reg-password" required>

                        <button type="submit">註冊</button>
                    </form>
                    <p>已有帳號？ <a href="#" id="show-login">登入</a></p>
                </div>
            </div>
        </div>

        <!-- 導覽列 -->
        <nav class="nav-container">
            <!-- 第一列 -->
            <div class="member-menu">
                <span id="login-status"></span>
                <button id="login-out"></button>
                <a id="register" href="#">
                    <img class="login-singup" src="../img/icons/user.png" alt="登入註冊">
                    <span id="user-state" class="tooltip">登入註冊</span>
                </a>
                <a href="#">
                    <img class="shopping-cart" src="../img/icons/shopping-cart.png" alt="購物車">
                    <span class="tooltip">購物車</span>
                </a>
                <a href="#">
                    <img class="contact-us" src="../img/icons/message.png" alt="聯絡我們">
                    <span class="tooltip">聯絡我們</span>
                </a>
            </div>

            <!-- 第二列 -->
            <div class="logo-container">
                <a href="../index.html"><img class="logo" src="../img/vegetable_LOGO.jpg" alt="綠藝饗宴 LOGO"></a>
                <a href="../index.html">
                    <h1 class="site-title">綠藝饗宴</h1>
                </a>
            </div>

            <!-- 第三列 -->
            <div class="menu-container">
                <div class="hamburger-menu" onclick="toggleMenu()">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
                <ul class="main-menu">
                    <li><a href="../index.html">首頁</a></li>
                    <li class="dropdown">
                        <a href="#">食譜分類&#9662;</a>
                        <ul class="submenu">
                            <li><a href="./recipeSelector.html?category=早餐">早餐</a></li>
                            <li><a href="./recipeSelector.html?category=飯">飯</a></li>
                            <li><a href="./recipeSelector.html?category=麵">麵</a></li>
                            <li><a href="./recipeSelector.html?category=米粉">米粉</a></li>
                            <li><a href="./recipeSelector.html?category=蔬菜">蔬菜</a></li>
                            <li><a href="./recipeSelector.html?category=鹹點">鹹點</a></li>
                            <li><a href="./recipeSelector.html?category=甜點">甜點</a></li>
                        </ul>
                    </li>
                    <li><a href="#">營養資訊</a></li>
                    <li><a href="#">購物清單</a></li>
                    <li><a href="#">聯絡我們</a></li>
                    <li><a href="#">常見問題</a></li>
                </ul>
            </div>
        </nav>

        <!-- 第四列 -->
        <div class="recipe-actions">
            <!-- 搜尋區塊 -->
            <div class="search-container">
                <label>探索其他食譜</label>
                <form>
                    <input type="text" id="search" name="search" placeholder="搜尋食譜或輸入食材">
                    <button type="submit"><img class="search-icon" src="../img/icons/search.png" alt="搜尋"></button>
                </form>
            </div>
            <!-- 上傳食譜 -->
            <a class="upload-button" href="./uploadRecipe.html">上傳您的素食食譜</a>
        </div>
    </header>

    <!-- 食譜詳情頁面 -->
    <div class="recipe-detail">

        <!-- 頁籤 -->
        <div class="breadcrumb"><!-- 動態生成頁籤 --></div>

        <!-- 用戶資訊 -->
        <a class="user-info" href="">
            <img class="user-avatar" src="../img/User/大頭照2.jpg" alt="用戶頭像">
            <p class="user-name" href="">用戶名稱</p>
            <p>200篇食譜</p>
            <p>3.8K粉絲</p>
        </a>

        <!-- 食譜介紹 -->
        <div class="recipe-header">
            <!-- 動態生成食譜介紹 -->
            <img class="left-section" id="left-section" src="" alt="">
            <div class="right-section">
                <span class="recipe-date"></span>
                <h2 class="recipe-title"></h2>
                <a class="rating" href="#"></a>
                <p class="recipe-tag"></p>
                <p class="recipe-description"></p>
                <div class="recipe-click">
                    <button class="like-button"><img src="../img/icons/heart_empty.png" alt="">0</button>
                    <button class="comment-button"><img src="../img/icons/message4.png" alt=""><span>0</span></button>
                    <button class="bookmark-button"><img src="../img/icons/bookmark_icon2.png" alt=""></button>
                    <button class="share-button"><img src="../img/icons/share_icon3.png" alt=""></button>
                </div>
            </div>
        </div>

        <!-- 食譜資訊 -->
        <div class="recipe-info">

            <!-- 食譜列表 -->
            <section class="ingredient">
                <!-- 食材 -->
                <div>
                    <div class="ingredient-info">
                        <h2>食材</h2>
                        <div>
                            <img src="../img/icons/fork_spoon_icon.png" alt="">
                            <span id="portion"></span>
                        </div>
                        <div>
                            <img src="../img/icons/clock_time_icon.png" alt="">
                            <span id="time"></span>
                        </div>
                    </div>
                    <table id="ingredient_table"><!-- 動態生成食材表格 --></table>

                </div>
            </section>

            <!-- 調味料 -->
            <section class="seasoning">
                <div>
                    <h2 class="section-title">調味料</h2>
                    <table id="seasoning_table"><!-- 動態生成調味料表格 --></table>
                </div>
            </section>

            <!-- 營養成分 -->
            <section class="nutrition">
                <div>
                    <h2 class="section-title">營養成分</h2>
                    <table id="nutrition_table"><!-- 動態生成營養成分表格 --></table>
                </div>
            </section>
        </div>

        <!-- 烹調步驟 -->
        <section class="recipe-steps">
            <h2>烹調步驟</h2>
            <div id="step_card"><!-- 動態生成烹調步驟 --></div>
        </section>

        <!-- 用戶評論 -->
        <section class="comments">
            <h2>用戶評論</h2>
            <div class="comment">
                <div class="comment-user-avatar">
                    <img src="../img/User/大頭照1.png" alt="用戶頭像">
                    <span>用戶名</span>
                </div>
                <p>這道菜真的很好吃！</p>
                <span>2025-02-18</span>
            </div>
            <div class="comment">
                <div class="comment-user-avatar">
                    <img src="../img/User/大頭照1.png" alt="用戶頭像">
                    <span>用戶名</span>
                </div>
                <p>非常簡單易做，而且味道很棒！</p>
                <span>2025-02-20</span>
            </div>
            <div class="comment">
                <div class="comment-user-avatar">
                    <img src="../img/User/大頭照1.png" alt="用戶頭像">
                    <span>用戶名</span>
                </div>
                <p>色彩繽紛又健康，一定會再做一次。</p>
                <span>2025-02-21</span>
            </div>
            <div class="comment">
                <div class="comment-user-avatar">
                    <img src="../img/User/大頭照1.png" alt="用戶頭像">
                    <span>用戶名</span>
                </div>
                <p>孩子們都很喜歡，連挑食的也吃光了！</p>
                <span>2025-02-22</span>
            </div>
            <div class="comment">
                <div class="comment-user-avatar">
                    <img src="../img/User/大頭照1.png" alt="用戶頭像">
                    <span>用戶名</span>
                </div>
                <p>簡直是晚餐的完美選擇，謝謝你的食譜。</p>
                <span>2025-02-23</span>
            </div>
            <div class="comment">
                <div class="comment-user-avatar">
                    <img src="../img/User/大頭照1.png" alt="用戶頭像">
                    <span>用戶名</span>
                </div>
                <p>真的很好吃，而且準備起來也不難。</p>
                <span>2025-02-24</span>
            </div>
            <div class="comment">
                <div class="comment-user-avatar">
                    <img src="../img/User/大頭照1.png" alt="用戶頭像">
                    <span>用戶名</span>
                </div>
                <p>這是我吃過最好吃的蔬菜料理之一。</p>
                <span>2025-02-24</span>
            </div>
            <form action="#" method="POST">
                <textarea name="comment-input" id="comment-input" rows="4" placeholder="添加評論..."></textarea>
                <button type="submit">提交</button>
            </form>
        </section>

        <!-- 相關食譜推薦 -->
        <section class="related-recipes">
            <h2>相關食譜</h2>
            <div class="related-carousel"><!-- 動態生成相關食譜推薦 --></div>
        </section>
    </div>


    <!-- 回到頂部按鈕 -->
    <img id="back-to-top" class="up-arrow" src="../img/icons/up-arrow_11044298.png" alt="回到頂部">


    <!-- 頁尾 -->
    <footer>
        <div class="footer-container">
            <div class="footer-links">
                <a href="#">關於我們</a>
                <a href="#">常見問題</a>
                <a href="#">隱私政策</a>
                <a href="#">使用條款</a>
                <a href="#">聯絡我們</a>
            </div>
            <div class="social-media-icons">
                <a href="#"><img src="../img/icons/line.png" alt="Line"></a>
                <a href="#"><img src="../img/icons/instagram.png" alt="Instagram"></a>
                <a href="#"><img src="../img/icons/facebook.png" alt="Facebook"></a>
            </div>
            <p>Copyright &copy; 2025 綠藝饗宴</p>
        </div>
    </footer>

    <script src="../JS/all.js"></script>
    <script src="../JS/recipe.js"></script>

    <script>
        // 從 URL 取得所需的 recipe id
        function getQueryParam(param) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(param);
        }
        const recipeId = getQueryParam('id');

        // 取得預設數據（從 JSON 檔案）與 localStorage 中的數據
        function getRecipesData() {
            // 從 localStorage 取得用戶新增的數據
            const storedData = localStorage.getItem('recipesData');
            const storedRecipes = storedData ? JSON.parse(storedData) : [];

            // 透過 fetch 取得預設數據
            return fetch('../recipes.json')
                .then(response => response.json())
                .then(defaultRecipes => {
                    // 合併預設數據與 localStorage 數據
                    // 此處假設兩者皆為陣列
                    return [...defaultRecipes, ...storedRecipes];
                });
        }

        // 取得數據後，根據網址參數 id 去找到對應的食譜並生成頁面內容
        getRecipesData()
            .then(recipesData => {
                // 根據 id 找到對應的一筆數據
                const recipe = recipesData.find(recipe => recipe.recipe_id === recipeId);
                if (recipe) {

                    // 解析 URL 中的查詢參數
                    const urlParams = new URLSearchParams(window.location.search);
                    const category = urlParams.get('category'); // 再次取得 category

                    // 動態變更頁籤內容
                    if (!category || category === "null") {
                        // 當 category 為 null、undefined 或者字串 "null" 時
                        const breadcrumb = document.querySelector('.breadcrumb');
                        breadcrumb.innerHTML = `
                            <a href="../index.html">首頁</a>
                            >
                            <a href="#">${recipe.recipe_title}</a>
                        `;
                    } else {
                        // 當 category 有正常值時
                        const breadcrumb = document.querySelector('.breadcrumb');
                        breadcrumb.innerHTML = `
                            <a href="../index.html">首頁</a>
                            >
                            <a href="#">${category}</a>
                            >
                            <a href="#">${recipe.recipe_title}</a>
                        `;
                    }

                    // ── 食譜介紹 ──

                    // 左區塊：圖片
                    const recipeImg = document.getElementById('left-section');
                    if (recipe.recipe_image) {
                        recipeImg.src = recipe.recipe_image;
                    } else {
                        recipeImg.className = 'not-found-img';
                        recipeImg.src = '../img/image_Not_Found.png';
                    }
                    recipeImg.alt = recipe.recipe_title;

                    // 右區塊

                    // 1. 時間
                    function formatDate(createdAt) {
                        const now = new Date();                   // 現在時間
                        const createdDate = new Date(createdAt);    // 建立時間轉 Date 物件
                        const timeDiff = now - createdDate;         // 毫秒差

                        const seconds = Math.floor(timeDiff / 1000);
                        const minutes = Math.floor(seconds / 60);
                        const hours = Math.floor(minutes / 60);
                        const days = Math.floor(hours / 24);

                        // 小於一天：顯示「幾秒前」、「幾分鐘前」或「幾小時前」
                        if (days < 1) {
                            if (hours >= 1) {
                                return `${hours} 小時前`;
                            } else if (minutes >= 1) {
                                return `${minutes} 分鐘前`;
                            } else {
                                return `${seconds} 秒前`;
                            }
                        }

                        // 大於一天但小於七天：顯示「幾天前」
                        if (days < 7) {
                            return `${days} 天前`;
                        }

                        // 大於或等於八天：若當年度只顯示月日，否則顯示完整年月日
                        const year = createdDate.getFullYear();
                        const month = createdDate.getMonth() + 1;
                        const day = createdDate.getDate();

                        if (year === now.getFullYear()) {
                            return `${month} 月 ${day} 日`;
                        }
                        return `${year} 年 ${month} 月 ${day} 日`;
                    }
                    const dateElement = document.querySelector('.recipe-date');
                    if (dateElement) {
                        dateElement.textContent = formatDate(recipe.created_at);
                    }

                    // 2. 標題
                    const titleElement = document.querySelector('.recipe-title');
                    if (titleElement) {
                        titleElement.textContent = recipe.recipe_title;
                    }

                    // 3. 評價（包含數字與星級圖示）
                    function generateStars(rating) {
                        const fullStars = Math.floor(rating);           // 完整星數
                        const halfStar = (rating % 1 >= 0.9) ? 1 : 0;     // 半星（此處邏輯可根據需求調整）
                        const emptyStars = 5 - fullStars - halfStar;
                        return '★'.repeat(fullStars) + '☆'.repeat(emptyStars);
                    }
                    const stars = document.createElement('span');
                    stars.textContent = generateStars(recipe.rating);

                    const ratingElement = document.querySelector('.rating');
                    if (ratingElement) {
                        // 利用 append 可同時加入字串與 DOM 節點
                        ratingElement.append(recipe.rating + ' / 5', stars, `（${recipe.evaluate} 評價）`);
                    }

                    // 4. 標籤
                    const recipeTagElement = document.querySelector('.recipe-tag');
                    if (recipeTagElement) {
                        recipe.tags.forEach(tagText => {
                            const tag = document.createElement('span');
                            tag.className = 'tag';
                            tag.textContent = tagText;
                            recipeTagElement.append(tag);
                        });
                    }

                    // 5. 介紹
                    const descriptionElement = document.querySelector('.recipe-description');
                    if (descriptionElement) {
                        descriptionElement.textContent = recipe.recipe_description;
                    }

                    // 6. 喜歡數
                    const likeButton = document.querySelector('.like-button');
                    // childNodes 包含了所有類型節點，數字在第二個節點（索引 1）
                    if (likeButton && likeButton.childNodes[1]) {
                        likeButton.childNodes[1].nodeValue = recipe.likes;
                    }

                    // 7. 留言
                    const commentButtonSpan = document.querySelector('.comment-button span');
                    if (commentButtonSpan) {
                        commentButtonSpan.textContent = recipe.comments;
                    }

                    // ── 食譜資訊 ──

                    // 份量與烹調時間
                    const portionElement = document.getElementById('portion');
                    if (portionElement) portionElement.textContent = recipe.portion;
                    const timeElement = document.getElementById('time');
                    if (timeElement) timeElement.textContent = recipe.recipe_cook_time;

                    // 食材
                    const ingredientTable = document.getElementById('ingredient_table');
                    if (ingredientTable) {
                        recipe.ingredients.forEach(ingredient => {
                            const row = document.createElement('tr');
                            const nameTd = document.createElement('td');
                            nameTd.textContent = ingredient.name;
                            const amountTd = document.createElement('td');
                            amountTd.textContent = ingredient.amount;
                            row.append(nameTd, amountTd);
                            ingredientTable.append(row);
                        });
                    }

                    // 調味料
                    const seasoningTable = document.getElementById('seasoning_table');
                    if (seasoningTable) {
                        recipe.seasonings.forEach(seasoning => {
                            const row = document.createElement('tr');
                            const nameTd = document.createElement('td');
                            nameTd.textContent = seasoning.name;
                            const amountTd = document.createElement('td');
                            amountTd.textContent = seasoning.amount;
                            row.append(nameTd, amountTd);
                            seasoningTable.append(row);
                        });
                    }

                    // 營養成分
                    const nutritionTable = document.getElementById('nutrition_table');
                    if (nutritionTable) {
                        recipe.nutritions.forEach(nutrition => {
                            const row = document.createElement('tr');
                            const nameTd = document.createElement('td');
                            nameTd.textContent = nutrition.name;
                            const valueTd = document.createElement('td');
                            valueTd.textContent = nutrition.value;
                            row.append(nameTd, valueTd);
                            nutritionTable.append(row);
                        });
                    }

                    // ── 烹調步驟 ──
                    const stepCardContainer = document.getElementById('step_card');
                    if (stepCardContainer) {
                        recipe.steps.forEach((step, index) => {
                            const stepCard = document.createElement('div');
                            stepCard.className = 'recipe-step';

                            // 步驟圖片
                            const stepImg = document.createElement('img');
                            if (step.image) {
                                stepImg.src = step.image;
                            } else {
                                stepImg.className = 'not-found-img';
                                stepImg.src = '../img/image_Not_Found.png';
                            }
                            stepImg.alt = `步驟 ${index + 1}`;

                            // 步驟文字內容
                            const stepContent = document.createElement('div');
                            const stepTitle = document.createElement('h2');
                            stepTitle.textContent = index + 1;
                            const stepText = document.createElement('p');
                            stepText.textContent = step.description;

                            stepContent.append(stepTitle, stepText);
                            stepCard.append(stepImg, stepContent);
                            stepCardContainer.append(stepCard);
                        });
                    }
                } else {
                    console.error('Recipe not found for id:', recipeId);
                }

                // ── 相關食譜推薦 ──
                // 取得容器【.related-carousel】
                const relatedCarousel = document.querySelector('.related-carousel');
                // 印出每筆 recipesData 資料
                recipesData.forEach(recipe => {
                    // 建立一個新的 relatedCard 區塊
                    const relatedCard = document.createElement('div');
                    relatedCard.classList.add('related-recipe-card');

                    // 建立連結元素，並設定連結到詳細食譜頁
                    const link = document.createElement('a');
                    link.href = `./recipe.html?id=${recipe.recipe_id}`;

                    // 建立圖片元件
                    const img = document.createElement('img');
                    if (recipe.recipe_image) {
                        img.src = recipe.recipe_image;
                    } else {
                        img.src = "../img/image_Not_Found.png";
                        img.classList.add('not-found-img');
                    }
                    img.alt = recipe.recipe_title;

                    // 建立標題 (h3) 元素
                    const title = document.createElement('h3');
                    title.textContent = recipe.recipe_title;

                    // 建立標籤區塊
                    const tagBox = document.createElement('div');
                    tagBox.classList.add('tags');
                    // 遍歷每個標籤，並建立 <span>
                    recipe.tags.forEach((tag) => {
                        const relatedTag = document.createElement('span');
                        relatedTag.textContent = tag;
                        tagBox.append(relatedTag);
                    });

                    // 建立描述 (p) 元素
                    const description = document.createElement('p');
                    description.textContent = recipe.recipe_description;

                    // 將圖、標題、標籤與描述加入連結元素中
                    link.append(img, title, tagBox, description);

                    // 建立動作按鈕區塊
                    const actionsBox = document.createElement('div');
                    actionsBox.classList.add('actions');

                    // 建立顯示評分的連結文字
                    const actionsLink = document.createElement('a');
                    actionsLink.textContent = `評分：${recipe.rating} / 5（${recipe.evaluate} 評價）`;

                    // 建立按鈕容器
                    const actionsBtn = document.createElement('div');

                    // 建立收藏按鈕，並綁定點擊事件
                    const collectBtn = document.createElement('button');
                    collectBtn.textContent = '收藏';
                    collectBtn.onclick = () => {
                        alert('使用 onclick 屬性綁定的點擊事件：收藏成功');
                    };

                    // 建立分享按鈕，並使用 addEventListener 綁定點擊事件
                    const shareBtn = document.createElement('button');
                    shareBtn.textContent = '分享';
                    shareBtn.addEventListener('click', () => {
                        alert('使用 addEventListener 綁定的點擊事件：分享成功');
                    });

                    // 將集合按鈕放入按鈕容器中
                    actionsBtn.append(collectBtn, shareBtn);

                    // 將評分連結和按鈕容器加入按鈕區塊中
                    actionsBox.append(actionsLink, actionsBtn);

                    // 將連結元素與按鈕區塊加入整個 relatedCard
                    relatedCard.append(link, actionsBox);

                    // 將該 relatedCard 加入到 relatedCarousel 中
                    relatedCarousel.append(relatedCard);
                });
            })
            .catch(error => {
                console.error('Error fetching or processing data:', error);
            });
    </script>

</body>

</html>