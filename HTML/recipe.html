<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="綠藝饗宴 - 最佳素食食譜平台">
    <title>食譜詳情 - 綠藝饗宴</title>
    <link rel="stylesheet" href="../CSS/recipe.css">
</head>

<!-- 此頁面為素食食譜詳細資訊的瀏覽頁 專題網站單純使用前端技術不加入後端相關技術 -->

<body>
    <!-- 頁首 -->
    <header>
        <!-- Modal Container -->
        <div class="modal-container">
            <!-- 登入 Modal -->
            <div id="login-modal" class="modal">
                <div class="modal-content">
                    <button class="close-btn" aria-label="Close">&times;</button>
                    <h2>登入</h2>
                    <form id="login-form">
                        <div class="form-group">
                            <label for="login-email">電子郵件:</label>
                            <input type="email" id="login-email" maxlength="100" required>
                        </div>
                        <div class="form-group">
                            <label for="login-password">密碼:</label>
                            <input type="password" id="login-password" maxlength="20" required>
                        </div>
                        <button type="submit" class="btn-primary">登入</button>
                    </form>
                    <p>尚未註冊嗎？ <button id="show-register">註冊</button></p>
                </div>
            </div>

            <!-- 註冊 Modal -->
            <div id="register-modal" class="modal">
                <div class="modal-content">
                    <button class="close-btn" aria-label="Close">&times;</button>
                    <h2>註冊</h2>
                    <form id="register-form">
                        <div class="form-group">
                            <label for="reg-username">姓名:</label>
                            <input type="text" id="reg-username" maxlength="20" required>
                        </div>
                        <div class="form-group">
                            <label for="reg-email">電子郵件:</label>
                            <input type="email" id="reg-email" maxlength="50" required>
                            <span id="email-error" class="error-message"></span>
                        </div>
                        <div class="form-group">
                            <label for="reg-password">密碼:</label>
                            <input type="password" id="reg-password" maxlength="20" required>
                        </div>
                        <div class="form-group">
                            <label for="reg-password">確認密碼:</label>
                            <input type="password" id="confirm-password" maxlength="20" required>
                        </div>
                        <button type="submit" class="btn-primary">註冊</button>
                    </form>
                    <p>已有帳號？ <button id="show-login">登入</button></p>
                </div>
            </div>
        </div>

        <div id="trash-modal" class="modal">
            <div class="modal-content">
                <button class="close-btn" aria-label="Close">&times;</button>
                <div id="trash-recipes"><!-- 動態生成多個 trash-item 項目 --></div>
            </div>
        </div>

        <!-- 導覽列 -->
        <nav class="nav-container">

            <!-- 漢堡按鈕 -->
            <div id="hamburger-menu">
                <span></span>
                <span></span>
                <span></span>
            </div>

            <!-- 第一列 -->
            <div class="member-menu">
                <span class="login-status"></span>
                <button class="login-out"></button>
                <button class="login-register">
                    <img class="login-singup" src="../img/icons/user.png" alt="登入註冊" />
                    <span class="tooltip">登入註冊</span>
                </button>
                <button class="shopping-cart">
                    <img src="../img/icons/shopping-cart.png" alt="購物車">
                    <span class="tooltip">購物車</span>
                </button>
                <button class="message">
                    <img src="../img/icons/message.png" alt="聯絡我們">
                    <span class="tooltip">聯絡我們</span>
                </button>
            </div>

            <!-- 第二列 -->
            <div class="logo-container">
                <a href="../index.html"><img class="logo" src="../img/vegetable_LOGO.jpg" alt="綠藝饗宴 LOGO"></a>
                <a href="../index.html">
                    <h1 class="site-title">綠藝饗宴</h1>
                </a>
            </div>

            <!-- 第三列 -->
            <div class="menu-container">
                <ul class="main-menu">
                    <li><a href="../index.html">首頁</a></li>
                    <li id="dropdown" class="dropdown">
                        <a href="#" class="recipe-category">食譜分類<span class="arrow">&#9662;</span></a>
                        <ul class="submenu">
                            <li><a href="./recipeSelector.html?category=早餐">早餐</a></li>
                            <li><a href="./recipeSelector.html?category=飯">飯</a></li>
                            <li><a href="./recipeSelector.html?category=麵">麵</a></li>
                            <li><a href="./recipeSelector.html?category=米粉">米粉</a></li>
                            <li><a href="./recipeSelector.html?category=蔬菜">蔬菜</a></li>
                            <li><a href="./recipeSelector.html?category=鹹點">鹹點</a></li>
                            <li><a href="./recipeSelector.html?category=甜點">甜點</a></li>
                        </ul>
                    </li>
                    <li class="submenu-open"><a href="#">營養資訊</a></li>
                    <li><a href="#">購物清單</a></li>
                    <li><a href="#">聯絡我們</a></li>
                    <li><a href="#">常見問題</a></li>
                </ul>
            </div>

            <!-- 介面小於768px 整合選單 -->
            <div class="combint-background"></div>
            <div class="combint-menu">
                <!-- 第一列: 會員相關選單 -->
                <ul class="combint">
                    <li></li>
                    <li class="combint-status"><span class="login-status"></span><button class="login-out">登出</button>
                    </li>
                    <li class="member">
                        <button class="login-register">
                            <img class="login-singup" src="../img/icons/user.png" alt="登入註冊" />
                            <span class="user-state tooltip">登入註冊</span>
                        </button>
                        <button class="shopping-cart">
                            <img src="../img/icons/shopping-cart.png" alt="購物車">
                            <span class="tooltip">購物車</span>
                        </button>
                        <button class="message">
                            <img src="../img/icons/message.png" alt="聯絡我們">
                            <span class="tooltip">聯絡我們</span>
                        </button>
                    </li>
                    <!-- 第三列: 原本的主選單 -->
                    <div class="main">
                        <li><a href="./index.html">首頁</a></li>
                        <li id="dropdown-btn">
                            <a href="#" class="recipe-category">食譜分類&#9662;</a>
                            <ul class="submenu">
                                <li><a href="./HTML/recipeSelector.html?category=早餐">早餐</a></li>
                                <li><a href="./HTML/recipeSelector.html?category=飯">飯</a></li>
                                <li><a href="./HTML/recipeSelector.html?category=麵">麵</a></li>
                                <li><a href="./HTML/recipeSelector.html?category=米粉">米粉</a></li>
                                <li><a href="./HTML/recipeSelector.html?category=蔬菜">蔬菜</a></li>
                                <li><a href="./HTML/recipeSelector.html?category=鹹點">鹹點</a></li>
                                <li><a href="./HTML/recipeSelector.html?category=甜點">甜點</a></li>
                            </ul>
                        </li>
                        <li class="submenu-open"><a href="#">營養資訊</a></li>
                        <li><a href="#">購物清單</a></li>
                        <li><a href="#">聯絡我們</a></li>
                        <li><a href="#">常見問題</a></li>
                    </div>
                </ul>
            </div>

        </nav>

        <!-- 第四列 -->
        <div class="recipe-actions">
            <!-- 搜尋區塊 -->
            <div class="search-container">
                <label>立即探索食譜</label>
                <form id="globalSearchForm">
                    <input type="text" id="search-input" name="search" placeholder="搜尋食譜或輸入食材" />
                    <button type="button" id="clear-btn" aria-label="清除">×</button>
                    <button type="submit" id="search-btn">
                        <img class="search-icon" src="../img/icons/search.png" alt="搜尋" />
                    </button>
                </form>
            </div>
            <!-- 上傳食譜 -->
            <a class="upload-button" href="./uploadRecipe.html">上傳您的素食食譜</a>
        </div>
    </header>

    <!-- 食譜詳情頁面 -->
    <div class="recipe-detail">

        <!-- 頁籤 -->
        <div class="breadcrumb"><!-- 動態生成頁籤 --></div>

        <!-- 用戶資訊 -->
        <div class="user-info">
            <a class="user-link" href=""></a>
            <button class="delete-button">將該食譜移至垃圾桶</button>
        </div>

        <!-- 食譜介紹 -->
        <div class="recipe-header">
            <!-- 動態生成食譜介紹 -->
            <img class="left-section" id="left-section" src="" alt="">
            <div class="right-section">
                <span class="recipe-date"></span>
                <h2 class="recipe-title"></h2>
                <a class="rating" href="#"></a>
                <p class="recipe-tag"></p>
                <p class="recipe-description"></p>
                <div class="recipe-click">
                    <button class="like-button"><img src="../img/icons/heart_empty.png" alt="">0</button>
                    <button class="comment-button"><img src="../img/icons/message4.png" alt="">0</button>
                    <button class="bookmark-button"><img src="../img/icons/bookmark_icon2.png" alt=""></button>
                    <button class="share-button"><img src="../img/icons/share_icon3.png" alt=""></button>
                </div>
            </div>
        </div>

        <!-- 食譜資訊 -->
        <div class="recipe-info">

            <!-- 食譜列表 -->
            <section class="ingredient">
                <!-- 食材 -->
                <div>
                    <div class="ingredient-info">
                        <h2>食材</h2>
                        <div>
                            <img src="../img/icons/fork_spoon_icon.png" alt="">
                            <span id="portion"></span>
                        </div>
                        <div>
                            <img src="../img/icons/clock_time_icon.png" alt="">
                            <span id="time"></span>
                        </div>
                    </div>
                    <table id="ingredient_table"><!-- 動態生成食材表格 --></table>

                </div>
            </section>

            <!-- 調味料 -->
            <section class="seasoning">
                <div>
                    <h2 class="section-title">調味料</h2>
                    <table id="seasoning_table"><!-- 動態生成調味料表格 --></table>
                </div>
            </section>

            <!-- 營養成分 -->
            <section class="nutrition">
                <div>
                    <h2 class="section-title">營養成分</h2>
                    <table id="nutrition_table"><!-- 動態生成營養成分表格 --></table>
                </div>
            </section>
        </div>

        <!-- 烹調步驟 -->
        <section class="recipe-steps">
            <h2>烹調步驟</h2>
            <div id="step_card"><!-- 動態生成烹調步驟 --></div>
        </section>

        <!-- 用戶評論 -->
        <section class="comments">
            <h2>用戶評論</h2>
            <div class="comment">
                <div class="comment-user-avatar">
                    <img src="../img/User/大頭照1.png" alt="用戶頭像">
                    <span>用戶名</span>
                </div>
                <p>這道菜真的很好吃！</p>
                <span>2025-02-18</span>
            </div>
            <div class="comment">
                <div class="comment-user-avatar">
                    <img src="../img/User/大頭照1.png" alt="用戶頭像">
                    <span>用戶名</span>
                </div>
                <p>非常簡單易做，而且味道很棒！</p>
                <span>2025-02-20</span>
            </div>
            <div class="comment">
                <div class="comment-user-avatar">
                    <img src="../img/User/大頭照1.png" alt="用戶頭像">
                    <span>用戶名</span>
                </div>
                <p>色彩繽紛又健康，一定會再做一次。</p>
                <span>2025-02-21</span>
            </div>
            <div class="comment">
                <div class="comment-user-avatar">
                    <img src="../img/User/大頭照1.png" alt="用戶頭像">
                    <span>用戶名</span>
                </div>
                <p>孩子們都很喜歡，連挑食的也吃光了！</p>
                <span>2025-02-22</span>
            </div>
            <div class="comment">
                <div class="comment-user-avatar">
                    <img src="../img/User/大頭照1.png" alt="用戶頭像">
                    <span>用戶名</span>
                </div>
                <p>簡直是晚餐的完美選擇，謝謝你的食譜。</p>
                <span>2025-02-23</span>
            </div>
            <div class="comment">
                <div class="comment-user-avatar">
                    <img src="../img/User/大頭照1.png" alt="用戶頭像">
                    <span>用戶名</span>
                </div>
                <p>真的很好吃，而且準備起來也不難。</p>
                <span>2025-02-24</span>
            </div>
            <div class="comment">
                <div class="comment-user-avatar">
                    <img src="../img/User/大頭照1.png" alt="用戶頭像">
                    <span>用戶名</span>
                </div>
                <p>這是我吃過最好吃的蔬菜料理之一。</p>
                <span>2025-02-24</span>
            </div>
            <form action="#" method="POST">
                <textarea name="comment-input" id="comment-input" rows="4" placeholder="添加評論..."></textarea>
                <button type="submit">提交</button>
            </form>
        </section>

        <!-- 相關食譜推薦 -->
        <section class="related-recipes">
            <h2>相關食譜</h2>
            <div class="related-carousel"><!-- 動態生成相關食譜推薦 --></div>
        </section>
    </div>


    <!-- 回到頂部按鈕 -->
    <img id="back-to-top" class="up-arrow" src="../img/icons/up-arrow_11044298.png" alt="回到頂部">


    <!-- 頁尾 -->
    <footer>
        <div class="footer-container">
            <div class="footer-links">
                <a href="#">關於我們</a>
                <a href="#">常見問題</a>
                <a href="#">隱私政策</a>
                <a href="#">使用條款</a>
                <a href="#">聯絡我們</a>
            </div>
            <div class="social-media-icons">
                <a href="#"><img src="../img/icons/line.png" alt="Line"></a>
                <a href="#"><img src="../img/icons/instagram.png" alt="Instagram"></a>
                <a href="#"><img src="../img/icons/facebook.png" alt="Facebook"></a>
            </div>
            <p>Copyright &copy; 2025 綠藝饗宴</p>
        </div>
    </footer>

    <script>
        let allRecipesData = []; // 全局變數，用來暫存所有食譜資料

        const loggedInUser = localStorage.getItem('loggedInUser'); // 讀取當前登入的使用者
        const userId = loggedInUser ? JSON.parse(loggedInUser).user_id : null;

        const urlParams = new URLSearchParams(window.location.search); // 解析 URL 中的查詢參數
        const category = urlParams.get('category'); // 再次取得 category

        // 從 URL 取得所需的 recipe id
        function getQueryParam(param) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(param);
        }
        const recipeId = getQueryParam('id');

        // 取得食譜數據（從 JSON 檔案）與 localStorage 中的食譜數據
        function getRecipesData() {
            // 從 localStorage 取得用戶新增的數據
            const storedData = localStorage.getItem('recipes');
            const storedRecipes = storedData ? JSON.parse(storedData) : [];

            // 透過 fetch 取得預設數據
            return fetch('https://simon-ke.github.io/VeggieRecipesHub/data/recipes.json')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(defaultRecipes => {
                    // 合併預設數據與 localStorage 數據
                    return [...defaultRecipes, ...storedRecipes];
                });
        }

        // 取得使用者數據（從 JSON 檔案）與 localStorage 中的使用者數據
        function getUserData() {
            // 從 localStorage 取得用戶相關數據
            const storedData = localStorage.getItem('users');
            const storedUser = storedData ? JSON.parse(storedData) : [];

            // 透過 fetch 取得預設使用者數據
            return fetch('https://simon-ke.github.io/VeggieRecipesHub/data/users.json')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(defaultUser => {
                    // 合併預設數據與 localStorage 數據
                    return [...defaultUser, ...storedUser];
                });
        }


        async function init() {
            try {
                // 取得數據
                allRecipesData = await getRecipesData();
                // 根據網址參數 id 找到對應的一筆數據
                // find 方法 只會回傳第一個符合條件的元素，一旦找到第一個符合條件的元素後 find 就會立即停止搜尋，如果找不到符合的元素則回傳 undefined。
                // filter 方法 回傳所有符合條件的元素
                // 在 allRecipesData 陣列中尋找 recipe_id 等於 recipeId 的物件 
                const recipe = allRecipesData.find(recipe => String(recipe.recipe_id) === String(recipeId));
                if (!recipe) {
                    console.error(`找不到 recipe_id 等於 ${recipeId} 的食譜`);
                    return;
                }
                // 建立食譜內容
                renderRecipesData(recipe);
                renderRelatedRecipe(allRecipesData);

                // 在 recipe 物件中獲取 user_id
                const recipeUserId = recipe.user_id;
                const userData = await getUserData();
                // 在 userData 陣列中尋找 user_id 等於 recipeUserId 的物件
                const user = userData.find(user => String(user.user_id) === String(recipeUserId));
                if (!user) {
                    console.error(`找不到 user_id 等於 recipe.user_id 的使用者資料`);
                    document.querySelector('.user-info').innerHTML = '<p>找不到對應的使用者數據</p>';
                    return;
                } else {
                    // 建立使用者內容
                    renderUserData(user, recipe);
                }
            } catch (error) {
                console.error('初始化錯誤：', error);
            }
        }

        // 動態生成食譜的 HTML 函式
        function renderRecipesData(recipesData) {
            // 動態變更頁籤內容
            if (!category || category === "null") {
                // 當 category 為 null、undefined 或者字串 "null" 時
                const breadcrumb = document.querySelector('.breadcrumb');
                breadcrumb.innerHTML = `
                            <a href="../index.html">首頁</a>
                            >
                            <a href="#">${recipesData.recipe_title}</a>
                        `;
            } else {
                // 當 category 有正常值時
                const breadcrumb = document.querySelector('.breadcrumb');
                breadcrumb.innerHTML = `
                            <a href="../index.html">首頁</a>
                            >
                            <a href="#">${category}</a>
                            >
                            <a href="#">${recipesData.recipe_title}</a>
                        `;
            }

            // ── 食譜介紹 ──
            // 左測圖片區塊
            const recipeImg = document.getElementById('left-section');
            recipeImg.onerror = imgOnerror;
            // 檢查是否存在圖片，若無則顯示預設圖片
            if (recipesData.recipe_image) {
                recipeImg.src = recipesData.recipe_image;
            } else {
                recipeImg.src = '../img/image_Not_Found.png';
                recipeImg.classList.add('not-found-img');
            }
            recipeImg.alt = recipesData.recipe_title;

            // 右區塊
            // 發布時間處理
            function formatDate(createdAt) {
                const now = new Date();                   // 現在時間
                const createdDate = new Date(createdAt);    // 建立時間轉 Date 物件
                const timeDiff = now - createdDate;         // 毫秒差

                const seconds = Math.floor(timeDiff / 1000);
                const minutes = Math.floor(seconds / 60);
                const hours = Math.floor(minutes / 60);
                const days = Math.floor(hours / 24);

                // 小於一天：顯示「幾秒前」、「幾分鐘前」或「幾小時前」
                if (days < 1) {
                    if (hours >= 1) {
                        return `${hours} 小時前`;
                    } else if (minutes >= 1) {
                        return `${minutes} 分鐘前`;
                    } else {
                        return `${seconds} 秒前`;
                    }
                }

                // 大於一天但小於七天：顯示「幾天前」
                if (days < 7) {
                    return `${days} 天前`;
                }

                // 大於或等於八天：若當年度只顯示月日，否則顯示完整年月日
                const year = createdDate.getFullYear();
                const month = createdDate.getMonth() + 1;
                const day = createdDate.getDate();

                if (year === now.getFullYear()) {
                    return `${month} 月 ${day} 日`;
                }
                return `${year} 年 ${month} 月 ${day} 日`;
            }
            // 1. 時間
            const dateElement = document.querySelector('.recipe-date');
            dateElement.textContent = formatDate(recipesData.created_at);

            // 2. 標題
            const titleElement = document.querySelector('.recipe-title');
            titleElement.textContent = recipesData.recipe_title;

            // 3. 評價（包含數字與星級圖示）
            function generateStars(rating) {
                const fullStars = Math.floor(rating);          // 完整星數
                const halfStar = (rating % 1 > 1) ? 1 : 0;     // 半星
                const emptyStars = 5 - fullStars - halfStar;
                return '★'.repeat(fullStars) + '☆'.repeat(emptyStars);
            }
            const stars = document.createElement('span');
            stars.textContent = generateStars(recipesData.rating);

            const ratingElement = document.querySelector('.rating');
            // 無評價處理
            if (Number(recipesData.rating) > 0) {
                ratingElement.append(recipesData.rating, ' / 5', stars, `（${recipesData.evaluate} 評價）`);
            } else {
                ratingElement.textContent = '尚未有評價';
            }

            // 4. 標籤
            const recipeTagElement = document.querySelector('.recipe-tag');
            if (recipesData.tags) {
                recipesData.tags.forEach(tagText => {
                    const tag = document.createElement('span');
                    tag.className = 'tag';
                    tag.textContent = tagText;
                    recipeTagElement.append(tag);
                });
            }

            // 5. 介紹
            const descriptionElement = document.querySelector('.recipe-description');
            descriptionElement.textContent = recipesData.recipe_description;

            // 6. 喜歡數
            const likeButton = document.querySelector('.like-button');
            // childNodes 包含了所有類型節點，數字在第二個節點（索引 1）
            likeButton.childNodes[1].nodeValue = recipesData.likes;

            // 7. 留言
            const commentButton = document.querySelector('.comment-button');
            commentButton.childNodes[1].nodeValue = recipesData.comments;

            // 8. 收藏
            const bookmarkButton = document.querySelector('.bookmark-button');
            bookmarkButton.addEventListener('click', () => {
                if (!loggedInUser) {
                    alert('請先登入以收藏食譜！');
                } else {
                    alert(`收藏成功！已收藏食譜：${recipesData.recipe_title}`);
                    // 在此加入收藏邏輯，例如儲存到收藏列表
                }
            });

            // ── 食譜資訊 ──

            // 份量與烹調時間
            const portionElement = document.getElementById('portion');
            portionElement.textContent = recipesData.recipe_portion + `${recipesData.recipe_portion < 10 ? ' 人份' : ' 人份以上'}`;
            const timeElement = document.getElementById('time');
            timeElement.textContent = recipesData.recipe_cook_time + `${recipesData.recipe_cook_time < 180 ? ' 分鐘' : ' 分鐘以上'}`;

            // 食材
            const ingredientTable = document.getElementById('ingredient_table');
            recipesData.ingredients.forEach(ingredient => {
                const row = document.createElement('tr');
                const nameTd = document.createElement('td');
                nameTd.textContent = ingredient.name;
                const amountTd = document.createElement('td');
                amountTd.textContent = ingredient.value;
                row.append(nameTd, amountTd);
                ingredientTable.append(row);
            });

            // 調味料
            const seasoningTable = document.getElementById('seasoning_table');
            recipesData.seasonings.forEach(seasoning => {
                const row = document.createElement('tr');
                const nameTd = document.createElement('td');
                nameTd.textContent = seasoning.name;
                const amountTd = document.createElement('td');
                amountTd.textContent = seasoning.value;
                row.append(nameTd, amountTd);
                seasoningTable.append(row);
            });

            // 營養成分
            const nutritionTable = document.getElementById('nutrition_table');
            recipesData.nutritions.forEach(nutrition => {
                const row = document.createElement('tr');
                const nameTd = document.createElement('td');
                nameTd.textContent = nutrition.name;
                const valueTd = document.createElement('td');
                valueTd.textContent = nutrition.value;
                row.append(nameTd, valueTd);
                nutritionTable.append(row);
            });

            // ── 烹調步驟 ──
            const stepCardContainer = document.getElementById('step_card');
            recipesData.steps.forEach((step, index) => {
                const stepCard = document.createElement('div');
                stepCard.className = 'recipe-step';

                // 步驟圖片
                const stepImg = document.createElement('img');
                if (step.image) {
                    stepImg.src = step.image;
                } else {
                    stepImg.className = 'not-found-img';
                    stepImg.src = '../img/image_Not_Found.png';
                }

                stepImg.alt = `步驟 ${index + 1}`;

                // 步驟文字內容
                const stepContent = document.createElement('div');
                const stepTitle = document.createElement('h2');
                stepTitle.textContent = index + 1;
                const stepText = document.createElement('p');
                stepText.textContent = step.description;

                stepContent.append(stepTitle, stepText);
                stepCard.append(stepImg, stepContent);
                stepCardContainer.append(stepCard);
            });
        }

        // 動態生成相關食譜的 HTML 函式
        function renderRelatedRecipe(recipesData) {
            // ── 相關食譜推薦 ──
            // 取得容器【.related-carousel】
            const relatedCarousel = document.querySelector('.related-carousel');
            // 印出每筆 recipesData 資料
            recipesData.forEach(recipe => {
                // 建立一個新的 relatedCard 區塊
                const relatedCard = document.createElement('div');
                relatedCard.classList.add('related-recipe-card');

                // 建立連結元素，並設定連結到詳細食譜頁
                const link = document.createElement('a');
                link.href = `./recipe.html?category=${category}&id=${recipe.recipe_id}`;

                // 建立圖片元件
                const img = document.createElement('img');
                img.onerror = imgOnerror;
                if (recipe.recipe_image) {
                    img.src = recipe.recipe_image;
                } else {
                    img.src = "../img/image_Not_Found.png";
                    img.classList.add('not-found-img');
                }
                img.alt = recipe.recipe_title;

                // 建立標題 (h3) 元素
                const title = document.createElement('h3');
                title.textContent = recipe.recipe_title;
                // 建立標籤區塊
                const tagBox = document.createElement('div');
                tagBox.classList.add('tags');
                // 遍歷每個標籤，並建立 <span>
                recipe.tags.forEach((tag) => {
                    const relatedTag = document.createElement('span');
                    relatedTag.textContent = tag;
                    tagBox.append(relatedTag);
                });

                // 建立描述 (p) 元素
                const description = document.createElement('p');
                description.textContent = recipe.recipe_description;

                // 將圖、標題、標籤與描述加入連結元素中
                link.append(img, title, tagBox, description);

                // 建立動作按鈕區塊
                const actionsBox = document.createElement('div');
                actionsBox.classList.add('actions');

                // 建立顯示評分的連結文字
                const actionsLink = document.createElement('a');
                actionsLink.textContent = recipe.rating > 0 ? `評分：${recipe.rating} / 5（${recipe.evaluate} 評價）` : '尚未有評價';

                // 建立按鈕容器
                const actionsBtn = document.createElement('div');

                // 建立收藏按鈕，並綁定點擊事件
                const bookmarkButton = document.createElement('button');
                bookmarkButton.textContent = '收藏';
                bookmarkButton.addEventListener('click', () => {
                    if (!loggedInUser) {
                        alert('請先登入以收藏食譜！');
                    } else {
                        alert(`收藏成功！已收藏食譜：${recipe.recipe_title}`);
                        // 在此加入收藏邏輯，例如儲存到收藏列表
                    }
                });
                // 建立分享按鈕，並使用 addEventListener 綁定點擊事件
                const shareBtn = document.createElement('button');
                shareBtn.textContent = '分享';
                shareBtn.addEventListener('click', () => {
                    alert('使用 addEventListener 綁定的點擊事件：分享成功');
                });

                // 將集合按鈕放入按鈕容器中
                actionsBtn.append(bookmarkButton, shareBtn);

                // 將評分連結和按鈕容器加入按鈕區塊中
                actionsBox.append(actionsLink, actionsBtn);

                // 將連結元素與按鈕區塊加入整個 relatedCard
                relatedCard.append(link, actionsBox);

                // 將該 relatedCard 加入到 relatedCarousel 中
                relatedCarousel.append(relatedCard);
            });
        }

        // 動態生成使用者的 HTML 函式
        function renderUserData(userData, recipe) {
            const userSection = document.querySelector('.user-link');

            const userAvatar = document.createElement('img');
            userAvatar.classList.add('user-avatar');
            userAvatar.src = userData.user_avatar || '/img/User/user_Avatar.png';
            userAvatar.alt = userData.user_name || '使用者';

            const userName = document.createElement('p');
            userName.classList.add('user-name');
            userName.textContent = userData.user_name || '使用者';

            const totalRecipes = document.createElement('p');
            totalRecipes.textContent = `${userData.total_recipes || 0}篇食譜`;

            const fansCount = document.createElement('p');
            fansCount.textContent = `${userData.fans_count || 0}粉絲`;

            // 刪除食譜按鈕
            const deleteBtn = document.querySelector('.delete-button');
            if (userId === recipe.user_id) {
                deleteBtn.style.display = 'block';
            }
            // 使用刪除功能
            deleteBtn.addEventListener('click', () => {
                const confirmed = confirm(`確定要將食譜「${recipe.recipe_title}」移至垃圾桶？`);
                if (confirmed) {
                    // 1. 把食譜移到垃圾桶 (暫存處)
                    // 從 localStorage 取出原有垃圾桶資料，若不存在便建立一個空陣列
                    let trashData = JSON.parse(localStorage.getItem('trash')) || [];
                    trashData.push(recipe);
                    localStorage.setItem('trash', JSON.stringify(trashData));

                    // 2. 更新 allRecipesData：過濾掉要刪除的食譜
                    allRecipesData = allRecipesData.filter(item => item.recipe_id !== recipe.recipe_id);

                    // 3. 更新主食譜在 localStorage 中的資料 (存於 'recipes' key)
                    let localStorageRecipes = JSON.parse(localStorage.getItem('recipes')) || [];
                    localStorageRecipes = localStorageRecipes.filter(item => item.recipe_id !== recipe.recipe_id);
                    localStorage.setItem('recipes', JSON.stringify(localStorageRecipes));

                    alert('已成功將食譜移至垃圾桶！');

                    if (!category || category === "null") {
                        // 當 category 為 null、undefined 或者字串 "null" 時
                        window.location.href = './recipeSelector.html';
                    } else {
                        // 當 category 有正常值時
                        window.location.href = `./recipeSelector.html?category=${category}`;
                    }
                }
            });
            // 將使用者資料組合至 userSection
            userSection.append(userAvatar, userName, totalRecipes, fansCount);
        }

        // 為 img 元素綁定錯誤處理。
        function imgOnerror() {
            if (!this.classList.contains('not-found-img')) {
                this.src = '../img/image_Not_Found.png';
                this.classList.add('not-found-img');
            }
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>

    <script src="../JS/all.js"></script>
    <script src="../JS/recipe.js"></script>

</body>

</html>